<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì  ë°ì´í„° API í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        input, select {
            width: 200px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <h1>ì‹¤ì  ë°ì´í„° API í…ŒìŠ¤íŠ¸</h1>
    
    <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <h3>âœ… í˜„ì¬ ìƒíƒœ</h3>
        <p><strong>Supabase í”„ë¡œì íŠ¸:</strong> ì‹¤ì œ í”„ë¡œì íŠ¸ì— ì—°ê²°ë¨</p>
        <p><strong>API ì—”ë“œí¬ì¸íŠ¸:</strong> http://localhost:54322/functions/v1/performance-data</p>
        <p><strong>ìƒíƒœ:</strong> API í˜¸ì¶œ ì¤€ë¹„ ì™„ë£Œ</p>
        
        <h4>ğŸ”§ ì°¸ê³ ì‚¬í•­</h4>
        <ul>
            <li>ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ì— ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</li>
            <li>API í˜¸ì¶œ ì‹œ ì‹¤ì œ ë°ì´í„°ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.</li>
            <li>í•„í„° ì¡°ê±´ì„ ì„¤ì •í•˜ê³  APIë¥¼ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”.</li>
        </ul>
    </div>
    
    <div class="form-group">
        <label>ì •ì‚°ì›” ID:</label>
        <input type="number" id="settlement_month_id" placeholder="ì •ì‚°ì›” ID (ì„ íƒì‚¬í•­)">
    </div>
    
    <div class="form-group">
        <label>ì—…ì²´ ID:</label>
        <input type="text" id="company_id" placeholder="ì—…ì²´ UUID (ì„ íƒì‚¬í•­)">
    </div>
    
    <div class="form-group">
        <label>ê±°ë˜ì²˜ ID:</label>
        <input type="number" id="client_id" placeholder="ê±°ë˜ì²˜ ID (ì„ íƒì‚¬í•­)">
    </div>
    
    <div class="form-group">
        <label>ì œí’ˆ ID:</label>
        <input type="text" id="product_id" placeholder="ì œí’ˆ UUID (ì„ íƒì‚¬í•­)">
    </div>
    
    <div class="form-group">
        <label>ê²€ìˆ˜ ìƒíƒœ:</label>
        <select id="user_edit_status">
            <option value="">ì „ì²´</option>
            <option value="ëŒ€ê¸°">ëŒ€ê¸°</option>
            <option value="ê²€ìˆ˜ì¤‘">ê²€ìˆ˜ì¤‘</option>
            <option value="ì™„ë£Œ">ì™„ë£Œ</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>ì‹¤ì  ìœ í˜•:</label>
        <select id="record_type">
            <option value="">ì „ì²´</option>
            <option value="wholesale">ë„ë§¤</option>
            <option value="direct">ì§ê±°ë˜</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>ì‹œì‘ì¼:</label>
        <input type="date" id="date_from">
    </div>
    
    <div class="form-group">
        <label>ì¢…ë£Œì¼:</label>
        <input type="date" id="date_to">
    </div>
    
    <div class="form-group">
        <label>ì¡°íšŒ ê°œìˆ˜:</label>
        <input type="number" id="limit" value="50" min="1" max="1000">
    </div>
    
    <div class="form-group">
        <label>ì‹œì‘ ìœ„ì¹˜:</label>
        <input type="number" id="offset" value="0" min="0">
    </div>
    
    <button onclick="testAPI()">API í˜¸ì¶œ</button>
    <button onclick="clearForm()">í¼ ì´ˆê¸°í™”</button>
    <button onclick="loadSampleData()">ìƒ˜í”Œ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸</button>
    
    <div class="result">
        <h3>API ì‘ë‹µ ê²°ê³¼:</h3>
        <div id="result"></div>
    </div>

    <script>
        // Supabase ì„¤ì • (ë¡œì»¬ í™˜ê²½)
        const SUPABASE_URL = 'http://localhost:54322'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'
        
        async function testAPI() {
            const resultDiv = document.getElementById('result')
            resultDiv.innerHTML = 'API í˜¸ì¶œ ì¤‘...'
            
            try {
                // í¼ ë°ì´í„° ìˆ˜ì§‘
                const filter = {
                    settlement_month_id: getValue('settlement_month_id'),
                    company_id: getValue('company_id'),
                    client_id: getValue('client_id'),
                    product_id: getValue('product_id'),
                    user_edit_status: getValue('user_edit_status'),
                    record_type: getValue('record_type'),
                    date_from: getValue('date_from'),
                    date_to: getValue('date_to'),
                    limit: parseInt(getValue('limit')) || 50,
                    offset: parseInt(getValue('offset')) || 0
                }
                
                // ë¹ˆ ê°’ ì œê±°
                Object.keys(filter).forEach(key => {
                    if (filter[key] === '' || filter[key] === null || filter[key] === undefined) {
                        delete filter[key]
                    }
                })
                
                console.log('ìš”ì²­ í•„í„°:', filter)
                console.log('API URL:', `${SUPABASE_URL}/functions/v1/performance-data`)
                
                // API í˜¸ì¶œ
                const response = await fetch(`${SUPABASE_URL}/functions/v1/performance-data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(filter)
                })
                
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status)
                console.log('ì‘ë‹µ í—¤ë”:', Object.fromEntries(response.headers.entries()))
                
                // ì‘ë‹µ í…ìŠ¤íŠ¸ ë¨¼ì € í™•ì¸
                const responseText = await response.text()
                console.log('ì‘ë‹µ í…ìŠ¤íŠ¸:', responseText)
                
                let data
                try {
                    // ë¹ˆ ì‘ë‹µì¸ì§€ í™•ì¸
                    if (!responseText || responseText.trim() === '') {
                        throw new Error('ë¹ˆ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤.')
                    }
                    
                    // JSON íŒŒì‹± ì‹œë„
                    data = JSON.parse(responseText)
                } catch (parseError) {
                    console.error('JSON íŒŒì‹± ì—ëŸ¬:', parseError)
                    throw new Error(`ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${responseText.substring(0, 200)}...`)
                }
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>âœ… API í˜¸ì¶œ ì„±ê³µ</h4>
                            <p><strong>ì´ ë°ì´í„° ìˆ˜:</strong> ${data.total_count}</p>
                            <p><strong>ì‘ë‹µ ì‹œê°„:</strong> ${data.timestamp}</p>
                            <p><strong>ì ìš©ëœ í•„í„°:</strong></p>
                            <pre>${JSON.stringify(data.filter_applied, null, 2)}</pre>
                            <p><strong>ë°ì´í„° ìƒ˜í”Œ (ì²˜ìŒ 3ê°œ):</strong></p>
                            <pre>${JSON.stringify(data.data.slice(0, 3), null, 2)}</pre>
                        </div>
                    `
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            <h4>âŒ API í˜¸ì¶œ ì‹¤íŒ¨</h4>
                            <p><strong>ìƒíƒœ ì½”ë“œ:</strong> ${response.status}</p>
                            <p><strong>ì—ëŸ¬:</strong> ${data.error}</p>
                            <p><strong>ë©”ì‹œì§€:</strong> ${data.message}</p>
                        </div>
                    `
                }
                
            } catch (error) {
                console.error('API í˜¸ì¶œ ì—ëŸ¬:', error)
                
                let errorMessage = error.message
                
                if (error.message.includes('fetch')) {
                    errorMessage = `API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 
                    
ê°€ëŠ¥í•œ ì›ì¸:
1. Supabase ë¡œì»¬ í™˜ê²½ì´ ì•„ì§ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤
2. í¬íŠ¸ 54322ê°€ ì‚¬ìš© ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤
3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤

í•´ê²° ë°©ë²•:
1. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”
2. Docker ì»¨í…Œì´ë„ˆ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”: docker-compose ps
3. Supabase ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”: docker-compose logs supabase-local`
                }
                
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>âŒ API í˜¸ì¶œ ì‹¤íŒ¨</h4>
                        <p>${errorMessage}</p>
                    </div>
                `
            }
        }
        
        function getValue(id) {
            const element = document.getElementById(id)
            return element ? element.value : ''
        }
        
        function clearForm() {
            const inputs = document.querySelectorAll('input, select')
            inputs.forEach(input => {
                if (input.type === 'number') {
                    input.value = input.id === 'limit' ? '50' : '0'
                } else if (input.type === 'date') {
                    input.value = ''
                } else {
                    input.value = ''
                }
            })
            document.getElementById('result').innerHTML = ''
        }
        
        function loadSampleData() {
            // ìƒ˜í”Œ ë°ì´í„°ë¡œ í¼ ì±„ìš°ê¸°
            document.getElementById('user_edit_status').value = 'ì™„ë£Œ'
            document.getElementById('record_type').value = 'wholesale'
            document.getElementById('limit').value = '10'
            document.getElementById('offset').value = '0'
            
            // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ì´ë²ˆ ë‹¬ ì„¤ì •
            const today = new Date()
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1)
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0)
            
            document.getElementById('date_from').value = firstDay.toISOString().split('T')[0]
            document.getElementById('date_to').value = lastDay.toISOString().split('T')[0]
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
        window.onload = function() {
            const today = new Date()
            document.getElementById('date_to').value = today.toISOString().split('T')[0]
        }
    </script>
</body>
</html> 